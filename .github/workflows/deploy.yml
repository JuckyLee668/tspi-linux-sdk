run-name: ${{ github.actor }} is testing out GitHub Actions 🚀
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: | 
            sudo apt update
            sudo apt install -y git ssh make gcc libssl-dev liblz4-tool expect \
                  g++ patchelf chrpath gawk texinfo diffstat binfmt-support \
                  qemu-user-static live-build bison flex fakeroot cmake gcc-multilib \
                  g++-multilib unzip device-tree-compiler ncurses-dev python2 \
                  python-pip pyelftools debootstrap
      - name: init
        run: | 
          set -e
          expect -c '
          spawn ./build.sh init
          expect "Choose an option:"
          send "1\r"
          expect eof
          '
      - name: Build
        run: ./build.sh

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
           GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          tag_name: "v1.0.0-${{ github.run_number }}"  # 使用运行号确保 tag 唯一
          release_name: "Release v1.0.0-${{ github.run_number }}"
          body: "自动发布的 Release"
          draft: false
          prerelease: false


      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./output/update/Image/update.img  # 需要发布的文件路径
          asset_name: "update.img"  # 文件名
          asset_content_type: application/octet-stream
